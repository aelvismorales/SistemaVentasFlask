{%extends 'base.html' %}

{% block csslink %}
    <link rel="stylesheet" href="{{url_for('static',filename='css/nota_pedido.css')}}" />
{%endblock%}

{% block navbar %}
 <li class="nav-item">
    <a class="nav-link" aria-current="page" href="{{ url_for('product.buscar_producto')}}"><strong>Productos</strong></a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{url_for('note.ver_notas_pedido')}}" aria-current="page"><strong>Ve Notas de Pedido</strong></a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{url_for('note.ver_ingresos_salidas')}}" aria-current="page"><strong>Ver Detalle Caja</strong></a>
  </li>

  <li class="nav-item">
    <a class="nav-link" href="{{url_for('buyer.vercompradores')}}" aria-current="page"><strong>Ver Compradores</strong></a>
  </li>
  
  <li class="nav-item">
    <a class="nav-link" href="{{url_for('auth.logout')}}" onclick="limpiarLocalStorage()"><strong>Cerrar Sesion</strong></a>
  </li>
{% endblock %}

{% block messages %} 
  <div id="messagesLoader">

  </div>
{%endblock%}

{% block content %} 
  <div class="container-general">
    <div class="header-nota">
        <h2>Nota de Pedido</h2>
        <p>{{ current_user.get_nickname()}}</p>
    </div>
    <div class="container-comprador">
      <form action="#" method="post" id="buscarUsuarioDNI">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="input-group mb-3">
          <input type="text" class="form-control" placeholder="Buscar por DNI" aria-label="Buscar por DNI" aria-describedby="button-addon2" name="dni_comprador">
          <button class="btn btn-outline-success" type="submit" id="botonBuscarUsuarioDNI">Buscar</button>
        </div>
      </form>

      <form action="#" id="datosComprador" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="datos-usuario">
          <h4 style="text-align: left;">Datos Comprador</h3> 
          <div class="datos">

            <!--Nombre Comprador-->
            <div class="mb-3 row">
              <label for="nombre_comprador" class="col-sm-2 col-form-label">Comprador:</label>
              <div class="col-sm-10">
                <input type="text" class="form-control"  name="nombre_comprador" id="nombre_comprador" required>
              </div>
            </div>

            <!--Direccion Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="direccion_comprador">Direccion:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="direccion_comprador" id="direccion_comprador"  required>
              </div>
            </div>
            
            <!--DNI Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="dni_comprador">DNI:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="dni_comprador" id="dni_comprador"  required>
              </div>
            </div>

            <!--Telefono Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="telefono_comprador">Telefono:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="telefono_comprador" id="telefono_comprador"  required>
              </div>
            </div>
            
            <!--Estado 1-->
            <div class="input-group mb-1">
              <label class="input-group-text" for="inputEstado1">Estado:</label>
              <select class="form-select" name="inputEstado1" id="inputEstado1" required>
                <option selected>Seleccione</option>
                <option value="CANCELADO">CANCELADO</option>
                <option value="POR-CANCELAR">POR CANCELAR</option>
                <option value="PROFORMA">PROFORMA</option>
              </select>

              <!--Estado 2-->
              <select class="form-select" name="inputEstado2" id="inputEstado2" aria-label="Estado2" required>
                <option value="-" selected>-</option>
                <option value="ENTREGADO">ENTREGADO</option>
                <option value="POR-ENTREGAR">POR ENTREGAR</option>
              </select>
            </div>

            <div class="info-cancela">
              <h5 id="cancela-dinero"></h5>
              <h5 id="vuelto-dinero"></h5>
            </div>
          </div>        
        </div>

        <div class="datos-generales">
          <div class="metodos-pago">
            <h4 style="text-align: center;">Metodos de Pago</h3>
            <div class="input-group mb-2">
              <label class="input-group-text" for="acuenta">Acuenta</label>
              <select class="form-select" name="acuenta" id="acuentaselect">
                <option selected value="False">No</option>
                <option value="True">Si</option>
              </select>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoEfectivo" aria-label="pagoEfectivo">
              <div class="input-group">
                <span class="input-group-text" id="pagoEfectivoSpan">Efectivo</span>
                <input class="form-control" type="number" name="pagoEfectivoInput" id="pagoEfectivoInput" placeholder="0.00" min="0.1" step="0.01"  disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoVisa" aria-label="pagoVisa">
              <div class="input-group">
                <span class="input-group-text" id="pagoVisaSpan">Visa</span>
                <input class="form-control" type="number" name="pagoVisaInput" id="pagoVisaInput" placeholder="0.00" min="0.1" step="0.01" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoBBVA" aria-label="pagoBBVA">
              <div class="input-group">
                <span class="input-group-text" id="pagoBBVASpan">BBVA</span>
                <input class="form-control" type="number" name="pagoBBVAInput" id="pagoBBVAInput" placeholder="0.00" min="0.1" step="0.01" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoBCP" aria-label="pagoBCP">
              <div class="input-group">
                <span class="input-group-text" id="pagoBCPSpan">BCP</span>
                <input class="form-control" type="number" name="pagoBCPInput" id="pagoBCPInput" placeholder="0.00" min="0.1" step="0.01" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoYAPE" aria-label="pagoYAPE">
              <div class="input-group">
                <span class="input-group-text" id="pagoYapeSpan">Yape</span>
                <input class="form-control" type="number" name="pagoYAPEInput" id="pagoYAPEInput" placeholder="0.00" min="0.1" step="0.01" disabled>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div id="tabla-productos" class="container-tabla-productos">
 
    </div>

    <div class="container-botones-final">
      <div class="total">
        <h4 id="hTotal"></h4>
      </div>
      <div class="botones">
        <button class="btn btn-danger" id="cancelarNotaPedido">Vaciar</button>
        <button class="btn btn-primary" id="imprimirNotaPedido" disabled>Imprimir</button>
        <button class="btn btn-success" id="botonDatosComprador" type="submit">Guardar</button>
        
      </div>
  </div>

  {%endblock%}

  {% block scripts %}

  <!--Script para Limpiar el localstorage existente al cerrar sesion-->
<script>
  function limpiarLocalStorage(){
      localStorage.clear();
  }
</script>

  <!--Logica del Manejo de Inputs de Pago,Vuelto y Validacion de Formulario-->
  <script>
    // Coleccion de los checboxes y los inputs, se cambia el estado de habilitado segun el cambio de checkbox.
    const inputsPagoSelected = [
      { checkbox: document.getElementById("pagoEfectivo"), input: document.getElementById("pagoEfectivoInput") },
      { checkbox: document.getElementById("pagoVisa"), input: document.getElementById("pagoVisaInput") },
      { checkbox: document.getElementById("pagoBBVA"), input: document.getElementById("pagoBBVAInput") },
      { checkbox: document.getElementById("pagoBCP"), input: document.getElementById("pagoBCPInput") },
      { checkbox: document.getElementById("pagoYAPE"), input: document.getElementById("pagoYAPEInput") }
    ];

    inputsPagoSelected.forEach(({ checkbox, input }) => {
      checkbox.addEventListener("change", function() {
        input.disabled = !this.checked;
      });
    });

    // Function para actualizar si las condiciones de pago son conformes
    function updatePagoConforme() {
      const acuenta = document.getElementById("acuentaselect").value;
      const totalPago = parseFloat(localStorage.getItem('totalPagoText'));
      const subTotal = parseFloat(localStorage.getItem('subTotal'));
      const vuelto = parseFloat(localStorage.getItem('vueltoText'));
      if (acuenta === "True") {
        // If acuenta is True, totalPago should be less than subTotal and vuelto less than 0
        if (totalPago < subTotal && vuelto < 0) {
          localStorage.setItem('pagoConforme', true);
        } else {
          console.error('El total de los pagos no coincide con las condiciones de pago');
          localStorage.setItem('pagoConforme', false);
        }
      } else {
        // If acuenta is False, totalPago should be greater than or equal to subTotal and vuelto greater than or equal to 0
        if (totalPago >= subTotal && vuelto >= 0) {
          console.log('El total de los pagos coincide con las condiciones de pago');
          localStorage.setItem('pagoConforme', true);
        } else {
          console.error('El total de los pagos no coincide con las condiciones de pago');
          localStorage.setItem('pagoConforme', false);
        }
      }
    }

    // Se colecta los elementos de la vista para mostrar el dinero cancelado y el vuelto.
    const cancelaDinero = document.getElementById("cancela-dinero");
    const vueltoDinero = document.getElementById("vuelto-dinero");
    // Funcion para actualizar el total de pago y el vuelto    
    function updateTotalPagoText(){
      let totalPago = 0;
      inputsPagoSelected.forEach(({ checkbox, input }) => {
        if (checkbox.checked && input.value) {
          totalPago += parseFloat(input.value);
        } else if (input.value) {
          input.value = 0;
          totalPago -= parseFloat(input.value);
          if (totalPago < 0) {
            totalPago = 0;
            }
          }
      });

      //total pago -> Es la cantidad que la persona cancela
      //subTotal -> Es el total de la venta
      localStorage.setItem('totalPagoText',parseFloat(totalPago).toFixed(2));
      const subTotal = parseFloat(localStorage.getItem('subTotal'));
      const vuelto = totalPago - subTotal;
      localStorage.setItem('vueltoText',parseFloat(vuelto).toFixed(2));
      updatePagoConforme();
      cancelaDinero.textContent = "Cancela con: S/ " + localStorage.getItem("totalPagoText");
      vueltoDinero.textContent = "Vuelto: S/ " + localStorage.getItem("vueltoText");

    }

    inputsPagoSelected.forEach(({checkbox,input})=>{
      input.addEventListener("input",updateTotalPagoText);
      checkbox.addEventListener("change",updateTotalPagoText);
    })
    
    const acuenta=document.getElementById("acuentaselect");
    acuenta.addEventListener("change",updateTotalPagoText);


    document.getElementById("botonDatosComprador").addEventListener("click",function(event){
      updateTotalPagoText();
      updatePagoConforme();
      // Obteniendo datos del comprador del Formulario
      const formulario_DatosComprador = document.getElementById("datosComprador");
      const formData = new FormData(formulario_DatosComprador);
      let data = {};
      
      // Verificar si el formulario tiene datos validos para enviar y si el Pago es conforme
      if (formulario_DatosComprador.checkValidity()){
        formData.forEach((value,key)=>{
          data[key] = value;
        });

        // Validar que el nombre_comprador solo contenga letras, espacio o ['*','-','.']
        if (data["nombre_comprador"].match(/^[a-zA-Z\s*-.]+$/) == null){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              El campo Comprador solo puede contener letras o ['*','-','.]
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;
          return;
        }

        // Validar que el campo DNI solo contenga numeros o ['*','-','.]
        if (data["dni_comprador"].match(/^[0-9*-.]+$/) == null){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              El campo DNI solo puede contener numeros, o ['*','-','.]
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;
          return;
        }

        // Validar que el campo telefono_comprador solo contenga numeros o ['*','-','.]
        if (data["telefono_comprador"].match(/^[0-9*-.]+$/) == null){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              El campo Telefono solo puede contener numeros, o ['*','-','.]
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;
          return;
        }

        // Validar que los campos Comprador,DNI, Telefono y Direccion no esten vacios
        if (data["nombre_comprador"] == "" || data["dni_comprador"] == "" || data["telefono_comprador"] == "" || data["direccion_comprador"] == ""){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              Los campos Comprador, DNI, Telefono y Direccion no pueden estar vacios, rellene los campos correspondiente
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;
          return;
        }

        // Validar que inputEstado1 o inputEstado2 no sean iguales a "Seleccione"
        if (data["inputEstado1"] == "Seleccione" || data["inputEstado2"] == "Seleccione"){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              Los campos no pueden estar vacios, seleccione un estado
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;
          return;
        }

        // Obtener los productos de Local Storage
        let productos = JSON.parse(localStorage.getItem("productos"));

        // Agregando los productos al objeto data
        data["productos"] = productos;
        data["total_venta"] = localStorage.getItem("subTotal");
        data["total_pagado"] = localStorage.getItem("totalPagoText");
        data["vuelto"]= localStorage.getItem("vueltoText");
        data["pagoEfectivoInput"]= document.getElementById("pagoEfectivoInput").value;
        data["pagoVisaInput"]= document.getElementById("pagoVisaInput").value;
        data["pagoBBVAInput"]= document.getElementById("pagoBBVAInput").value;
        data["pagoBCPInput"]= document.getElementById("pagoBCPInput").value;
        data["pagoYAPEInput"]= document.getElementById("pagoYAPEInput").value;

        //Validar que los Input Pago no tengan valores negativos
        if (parseFloat(data["pagoEfectivoInput"]) < 0 || parseFloat(data["pagoVisaInput"]) < 0 || parseFloat(data["pagoBBVAInput"]) < 0 || parseFloat(data["pagoBCPInput"]) < 0 || parseFloat(data["pagoYAPEInput"]) < 0){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              Los campos de Pago no pueden tener valores negativos
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;
          return;
        }

        // Obtener el estado de pago conforme
        pago_conforme=localStorage.getItem("pagoConforme");
        if (pago_conforme=="true"){
          $.ajax({
            url:"/crearnotaventa",
            type:"POST",
            data:JSON.stringify(data),
            contentType:"application/json;",
            dataType:"json",
            headers:{"X-CSRFToken": "{{ csrf_token() }}"},
            success:function(response){
              document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
              `;
              var JSONproductos = localStorage.getItem('productos');
              var products = JSONproductos ? JSON.parse(JSONproductos) : [];

              products.forEach((element) => {
                let id = element.id;
                let tr = document.getElementById(id);
                tr.parentNode.removeChild(tr);
              });

              // Vaciar el array
              products.length = 0;
              localStorage.setItem('productos', JSON.stringify(products));
              localStorage.setItem("subTotal",0.00);
              localStorage.setItem("totalPagoText",0.00);
              document.getElementById("hTotal").textContent = "Total: S/0.00";
              document.getElementById("totalProductos").textContent = "0.00";

              cancelaDinero.textContent = "Cancela con: S/ " + "0.00";
              vueltoDinero.textContent = "Vuelto: S/ " + "0.00";

              // Limpiar los campos del comprador
              localStorage.setItem("nombre_comprador", '');
              localStorage.setItem("direccion_comprador", '');
              localStorage.setItem("telefono_comprador", '');
              localStorage.setItem("dni_comprador", '');

              // Activando boton imprimir
              document.getElementById("imprimirNotaPedido").disabled = false;
              //Agregar atributo data-id a boton imprimir
              document.getElementById("imprimirNotaPedido").setAttribute("data-id",response[0].id);
            },
            error:function(xhr,status,error){
              console.error("XHR object:", xhr);
              console.error("Status:", status);
              console.error("Error:", error);

              if (xhr.responseText){
                try{
                  var errorData = JSON.parse(xhr.responseText);
                  console.error("ErrorData:", errorData);
                }catch(e){
                  console.error("Error to Parse Json as response",e);
                }
              }

              document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                No se pudo guardar la Nota de Pedido
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
              `;
            }
          })

        }else{
          console.error("El total de los pagos no coincide con el subtotal");
          document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            El total de los pagos no coincide con el subtotal
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
          `;
        }
      }else{
        console.error("El formulario no tiene datos validos");
        document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            Los campos de comprador o pago no son validos, rellene los campos correspondientes, verificar que los campos de pago no sean negativos y que el total de los pagos coincida con el subtotal
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
      }
      event.preventDefault();
    });

    function vaciarTabla(){
      var JSONproductos = localStorage.getItem('productos');
      var productos = JSONproductos ? JSON.parse(JSONproductos) : [];

      // Verificar si productos no esta vacio
      if (productos.length == 0){
        console.error("No hay productos en la lista");
        document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            No hay productos en la lista
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
        return;
      }

      productos.forEach((element) => {
        let id = element.id;
        let tr = document.getElementById(id);
        tr.parentNode.removeChild(tr);
      });

      // Vaciar el array
      productos.length = 0;
      localStorage.setItem('productos', JSON.stringify(productos));
      // Guardar el array vacío de nuevo en localStorage
      localStorage.setItem('subTotal',0.00);
      localStorage.setItem('vueltoText',0.00);
      localStorage.setItem('totalPagoText',0.00);
      document.getElementById("hTotal").textContent = "Total: S/0.00";
      document.getElementById("totalProductos").textContent = "0.00";
      cancelaDinero.textContent = "Cancela con: S/ " + "0.00";
      vueltoDinero.textContent = "Vuelto: S/ " + "0.00";

    }
    // Capturar el evento de cancelar la nota de pedido y vaciar la lista de productos
    document.getElementById('cancelarNotaPedido').addEventListener('click', (event) => {
      vaciarTabla();
      event.preventDefault();
    });
  
  
    // Capturar el evento de imprimir la nota de pedido
    document.getElementById('imprimirNotaPedido').addEventListener('click', (event) => {
      event.preventDefault();
      let id = event.target.getAttribute("data-id");
      // Abrir una nueva ventana con la ruta para imprimir la nota de pedido
      url_imprimir = "/imprimire/"+id;
      window.open(url_imprimir, '_blank');
    });
  
  </script> 

  <!--Script para obtener datos de Compradores por DNI o RUC-->
  <script>
    //Si ya existen datos cargarlos cuando el DoomLoader este listo

    document.addEventListener('DOMContentLoaded',function(){
      if (localStorage.getItem("nombre_comprador") != null) {
        document.getElementById("nombre_comprador").value = localStorage.getItem("nombre_comprador");
        document.getElementById("direccion_comprador").value = localStorage.getItem("direccion_comprador");
        document.getElementById("telefono_comprador").value = localStorage.getItem("telefono_comprador");
        document.getElementById("dni_comprador").value = localStorage.getItem("dni_comprador");
      } else{
        document.getElementById("nombre_comprador").value = '';
        document.getElementById("direccion_comprador").value = '';
        document.getElementById("telefono_comprador").value = '';
        document.getElementById("dni_comprador").value = '';
      }
    })

    // Obtener datos de Compradores por DNI o RUC
    const buscarUsuarioDNI = document.getElementById("buscarUsuarioDNI");
    const botonBuscarUsuarioDNI = document.getElementById("botonBuscarUsuarioDNI");
    
    botonBuscarUsuarioDNI.addEventListener('click',(event)=>{
      event.preventDefault();
      
      const formData = new FormData(buscarUsuarioDNI);
      let data = {};
      formData.forEach((value,key)=>{
        data[key] = value;
      });

      // Validar que data["dni_comprador"] no sea vacio y que contenga solo numeros
      if (data["dni_comprador"] == ""){
        document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            El campo DNI no puede estar vacio
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
        return;
      }else if (data["dni_comprador"].match(/^[0-9*]+$/) == null ){
        document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            El campo DNI solo puede contener numeros
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
        return;
      }


      $.ajax({
        url: "{{ url_for('buyer.buscarcompradorbydni') }}",
        type: "POST",
        data: JSON.stringify(data),
        contentType: "application/json;",
        dataType: "json",
        headers: {"X-CSRFToken": "{{ csrf_token() }}"},
        success:function(response){
          if (response[1]==200){
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;

            // Guardar los datos del comprador en localStorage
            localStorage.setItem("nombre_comprador", response[0].nombre_comprador);
            localStorage.setItem("direccion_comprador", response[0].direccion_comprador);
            localStorage.setItem("telefono_comprador", response[0].telefono_comprador);
            localStorage.setItem("dni_comprador", response[0].dni_comprador);

            // Mostrar los datos del comprador en el formulario
            document.getElementById("nombre_comprador").value = localStorage.getItem("nombre_comprador");
            document.getElementById("direccion_comprador").value = localStorage.getItem("direccion_comprador");
            document.getElementById("telefono_comprador").value = localStorage.getItem("telefono_comprador");
            document.getElementById("dni_comprador").value = localStorage.getItem("dni_comprador");
          } else{
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;

            // Limpiar los campos del comprador
            document.getElementById("nombre_comprador").value = '';
            document.getElementById("direccion_comprador").value = '';
            document.getElementById("telefono_comprador").value = '';
            document.getElementById("dni_comprador").value = '';

            // Limpiar los datos del comprador en localStorage
            localStorage.removeItem("nombre_comprador");
            localStorage.removeItem("direccion_comprador");
            localStorage.removeItem("telefono_comprador");
            localStorage.removeItem("dni_comprador");
          }
          
        },error:function(error){
          console.error(error);
          document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-info alert-dismissible fade show" role="alert">
            El comprador no existe por favor registrelo
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
        }
      })
    })

  </script>

  <!--Script recuperar lista de productos-->
  <script>
    
    var productos= JSON.parse(localStorage.getItem("productos"));

    // Creamos la tabla
    let tabla=document.createElement("table");
    tabla.setAttribute("class","table table-striped table-hover");

    // Creamos el encabezado
    let thead=document.createElement("thead");
    let tr=document.createElement("tr");

    //Creando columnas
    let th1=document.createElement("th");
    th1.setAttribute("scope","col");
    th1.textContent="#";

    let th2=document.createElement("th");
    th2.setAttribute("scope","col");
    th2.textContent="Cantidad";

    let th3=document.createElement("th");
    th3.setAttribute("scope","col");
    th3.textContent="Producto";

    let th4=document.createElement("th");
    th4.setAttribute("scope","col");
    th4.textContent="Precio";

    let th5=document.createElement("th");
    th5.setAttribute("scope","col");
    th5.textContent="Subtotal";

    let th6=document.createElement("th");
    th6.setAttribute("scope","col");
    th6.textContent="Acciones";

    tr.appendChild(th1);
    tr.appendChild(th2);
    tr.appendChild(th3);
    tr.appendChild(th4);
    tr.appendChild(th5);
    tr.appendChild(th6);

    thead.appendChild(tr);

    tabla.appendChild(thead);

    
    // Llenar la tabla con los datos de productos
    let tbody=document.createElement("tbody");

    // Crea una variable total fuera del bucle para almacenar la suma de los subtotales.
    let total = 0;

    productos.forEach((element,index) => {
      let tr = document.createElement("tr");
      tr.setAttribute("id",element.id);

      let th= document.createElement("th");
      th.setAttribute("scope","row");
      th.textContent = index+1;

      let td1 = document.createElement("td");
      let inputCantidad=document.createElement("input");
      inputCantidad.setAttribute("class","tabla-input");
      inputCantidad.setAttribute("type","number");
      inputCantidad.setAttribute("min","0.1");
      inputCantidad.setAttribute("step","0.1");
      inputCantidad.setAttribute("value",element.cantidad);
      td1.appendChild(inputCantidad);

      inputCantidad.addEventListener("input",function(){
        let id = this.parentNode.parentNode.getAttribute("id");
        let cantidad = parseFloat(this.value);
        let precio = document.getElementById(id).childNodes[3].childNodes[0].value;
        let subtotal = cantidad*precio;
        document.getElementById(id).childNodes[4].textContent = subtotal.toFixed(2);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.map(function(producto){
          if(producto.id == id){
            producto.cantidad = cantidad;
          }
          return producto;
        });
        localStorage.setItem("productos",JSON.stringify(productosActualizados));
        // Actualiza la variable total
        updateTotal();
      });

      let td2 = document.createElement("td");
      td2.textContent = element.nombre_producto;

      let td3 = document.createElement("td");
      let inputPrecio=document.createElement("input");
      inputPrecio.setAttribute("class","tabla-input");
      inputPrecio.setAttribute("type","number");
      inputPrecio.setAttribute("min","0.1");
      inputPrecio.setAttribute("step","0.1");
      inputPrecio.setAttribute("value",element.precio_venta_producto);
      td3.appendChild(inputPrecio);

      inputPrecio.addEventListener("input",function(){
        let id = this.parentNode.parentNode.getAttribute("id");
        let precio = this.value;
        let cantidad = document.getElementById(id).childNodes[1].childNodes[0].value;
        let subtotal = cantidad*precio;
        document.getElementById(id).childNodes[4].textContent = subtotal.toFixed(2);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.map(function(producto){
          if(producto.id == id){
            producto.precio_venta_producto = precio;
          }
          return producto;
        });

        localStorage.setItem("productos",JSON.stringify(productosActualizados));

        // Actualiza la variable total
        updateTotal();
      });

      let td4 = document.createElement("td");
      td4.textContent =  (element.precio_venta_producto*element.cantidad).toFixed(2);

      let td5 = document.createElement("td");
      let button = document.createElement("button");
      button.setAttribute("class","btn btn-danger");
      button.setAttribute("id",element.id);
      button.textContent = "Eliminar";
      button.addEventListener("click",function(){
        let id = this.getAttribute("id");
        let tr = document.getElementById(id);
        tr.parentNode.removeChild(tr);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.filter(function(producto){
          return producto.id != id;
        });

        localStorage.setItem("productos",JSON.stringify(productosActualizados));

        // Actualiza la variable total
        updateTotal();
      });

      td5.appendChild(button);

      tr.appendChild(th);
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);
      tr.appendChild(td5);
      tbody.appendChild(tr);
      
    });

    function updateTotal() {
      // Recalcula el total sumando todos los subtotales
      total = 0;
      // Obtienes la lista de productos actualizada
      let productos = JSON.parse(localStorage.getItem("productos"));
      productos.forEach((element) => {
          let id = element.id;
          let subtotal = parseFloat(document.getElementById(id).childNodes[4].textContent);
          total += subtotal;
      });
      document.getElementById("totalProductos").textContent = total.toFixed(2);
      document.getElementById("hTotal").textContent = "Total: S/"+total.toFixed(2);
      localStorage.setItem("subTotal",total.toFixed(2));
      localStorage.setItem("total_venta_session",total.toFixed(2));
      
    }

    tabla.appendChild(tbody);

    let tableFooter = document.createElement("tfoot");
    let trFooter = document.createElement("tr");
    let tdFooter = document.createElement("td");
    tdFooter.setAttribute("colspan","4");
    tdFooter.setAttribute("style","text-align: right; font-weight: bold;");
    tdFooter.textContent = "Total: ";


    let tdFooterTotal = document.createElement("td");
    tdFooterTotal.setAttribute("id","totalProductos");
    tdFooterTotal.textContent = localStorage.getItem("subTotal");
    document.getElementById("hTotal").textContent = "Total: S/"+localStorage.getItem("subTotal");
    
    trFooter.appendChild(tdFooter);
    trFooter.appendChild(tdFooterTotal);
    tableFooter.appendChild(trFooter);


    tabla.appendChild(tableFooter);

    tabla_productos = document.getElementById("tabla-productos");
    tabla_productos.appendChild(tabla);

  </script>
{% endblock %}