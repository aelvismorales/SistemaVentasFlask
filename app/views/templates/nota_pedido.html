{%extends 'base.html' %}

{% block csslink %}
    <link rel="stylesheet" href="{{url_for('static',filename='css/nota_pedido.css')}}" />
{%endblock%}

{% block navbar %}
 <li class="nav-item">
    <a class="nav-link" aria-current="page" href="{{ url_for('product.buscar_producto')}}"><strong>Productos</strong></a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{url_for('note.ver_notas_pedido')}}" aria-current="page"><strong>Ve Notas de Pedido</strong></a>
  </li>

  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('buyer.vercompradores') }}" aria-current="page"><strong>Ver Compradores</strong></a>
  </li>
  
  <li class="nav-item">
    <a class="nav-link" href="{{url_for('auth.logout')}}"><strong>Cerrar Sesion</strong></a>
  </li>
{% endblock %}

{% block messages %} 
  <div id="messagesLoader">

  </div>
{%endblock%}

{% block content %} 
  <div class="container-general">
    <div class="header-nota">
        <h2>Nota de Pedido</h2>
        <p>{{ current_user.get_nickname()}}</p>
    </div>
    <div class="container-comprador">
      <form action="#" method="post" id="buscarUsuarioDNI">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="input-group mb-3">
          <input type="text" class="form-control" placeholder="Buscar por DNI" aria-label="Buscar por DNI" aria-describedby="button-addon2" name="dni_comprador">
          <button class="btn btn-outline-success" type="submit" id="botonBuscarUsuarioDNI">Buscar</button>
        </div>
      </form>

      <form action="#" id="datosComprador" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="datos-usuario">
          <h4 style="text-align: left;">Datos Comprador</h3> 
          <div class="datos">

            <!--Nombre Comprador-->
            <div class="mb-3 row">
              <label for="nombre_comprador" class="col-sm-2 col-form-label">Comprador:</label>
              <div class="col-sm-10">
                <input type="text" class="form-control"  name="nombre_comprador" id="nombre_comprador" required>
              </div>
            </div>

            <!--Direccion Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="direccion_comprador">Direccion:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="direccion_comprador" id="direccion_comprador"  required>
              </div>
            </div>
            
            <!--DNI Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="dni_comprador">DNI:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="dni_comprador" id="dni_comprador"  required>
              </div>
            </div>

            <!--Telefono Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="telefono_comprador">Telefono:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="telefono_comprador" id="telefono_comprador"  required>
              </div>
            </div>
            
            <!--Estado 1-->
            <div class="input-group mb-1">
              <label class="input-group-text" for="inputEstado1">Estado:</label>
              <select class="form-select" name="inputEstado1" id="inputEstado1" required>
                <option selected>Seleccione</option>
                <option value="CANCELADO">CANCELADO</option>
                <option value="POR-CANCELAR">POR CANCELAR</option>
                <option value="PROFORMA">PROFORMA</option>
              </select>

              <!--Estado 2-->
              <select class="form-select" name="inputEstado2" id="inputEstado2" aria-label="Estado2" required>
                <option selected>Seleccione</option>
                <option value="-">-</option>
                <option value="ENTREGADO">ENTREGADO</option>
                <option value="POR-ENTREGAR">POR ENTREGAR</option>
              </select>
            </div>

            <div class="info-cancela">
              <h5 id="cancela-dinero"></h5>
              <h5 id="vuelto-dinero"></h5>
            </div>
          </div>        
        </div>

        <div class="datos-generales">
          <div class="metodos-pago">
            <h4 style="text-align: center;">Metodos de Pago</h3>
            <div class="input-group mb-2">
              <label class="input-group-text" for="acuenta">Acuenta</label>
              <select class="form-select" name="acuenta" id="acuentaselect">
                <option selected value="False">No</option>
                <option value="True">Si</option>
              </select>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoEfectivo" aria-label="pagoEfectivo">
              <div class="input-group">
                <span class="input-group-text" id="pagoEfectivoSpan">Efectivo</span>
                <input class="form-control" type="number" name="pagoEfectivoInput" id="pagoEfectivoInput" placeholder="0.00" min="0.1" step="0.01"  disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoVisa" aria-label="pagoVisa">
              <div class="input-group">
                <span class="input-group-text" id="pagoVisaSpan">Visa</span>
                <input class="form-control" type="number" name="pagoVisaInput" id="pagoVisaInput" placeholder="0.00" min="0.1" step="0.01" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoBBVA" aria-label="pagoBBVA">
              <div class="input-group">
                <span class="input-group-text" id="pagoBBVASpan">BBVA</span>
                <input class="form-control" type="number" name="pagoBBVAInput" id="pagoBBVAInput" placeholder="0.00" min="0.1" step="0.01" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoBCP" aria-label="pagoBCP">
              <div class="input-group">
                <span class="input-group-text" id="pagoBCPSpan">BCP</span>
                <input class="form-control" type="number" name="pagoBCPInput" id="pagoBCPInput" placeholder="0.00" min="0.1" step="0.01" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoYAPE" aria-label="pagoYAPE">
              <div class="input-group">
                <span class="input-group-text" id="pagoYapeSpan">Yape</span>
                <input class="form-control" type="number" name="pagoYAPEInput" id="pagoYAPEInput" placeholder="0.00" min="0.1" step="0.01" disabled>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div id="tabla-productos" class="container-tabla-productos">

    </div>

    <div class="container-botones-final">
      <div class="total">
        <h4 id="hTotal"></h4>
      </div>
      <div class="botones">
        <button class="btn btn-danger" id="cancelarNotaPedido">Vaciar</button>        
        <button class="btn btn-success" id="botonDatosComprador" type="submit">Guardar</button>
        
      </div>
  </div>

  {%endblock%}

  {% block scripts %}
  <script>
    // Se colecta los checkboxes y cambia el estado de los inputs de deshabilitado a habilitado y viceversa
    const pagoEfectivo = document.getElementById("pagoEfectivo");
    pagoEfectivo.addEventListener("change",function(){
      document.getElementById("pagoEfectivoInput").disabled = !this.checked;
    });

    const pagoVisa = document.getElementById("pagoVisa");
    pagoVisa.addEventListener("change",function(){
      document.getElementById("pagoVisaInput").disabled = !this.checked;
    });

    const pagoBBVA = document.getElementById("pagoBBVA");
    pagoBBVA.addEventListener("change",function(){
      document.getElementById("pagoBBVAInput").disabled = !this.checked;
    });

    const pagoBCP = document.getElementById("pagoBCP");
    pagoBCP.addEventListener("change",function(){
      document.getElementById("pagoBCPInput").disabled = !this.checked;
    });

    const pagoYAPE = document.getElementById("pagoYAPE");
    pagoYAPE.addEventListener("change",function(){
      document.getElementById("pagoYAPEInput").disabled = !this.checked;
    });

    

    // Se colecta los inputs de los pagos y se calcula el vuelto
    const cancelaDinero = document.getElementById("cancela-dinero");
    const vueltoDinero = document.getElementById("vuelto-dinero");

    // Se colecta los inputs de los pagos para calcular la suma total de lo pagado ademas se calcula el vuelto
    const inputsPago = [
        document.getElementById('pagoEfectivoInput'),
        document.getElementById('pagoVisaInput'),
        document.getElementById('pagoBBVAInput'),
        document.getElementById('pagoBCPInput'),
        document.getElementById('pagoYAPEInput')
    ];

    // Recorre los inputs de los pagos y calcula la suma total de lo pagado
    inputsPago.forEach(input=>{
      input.addEventListener('input',function(){
        let totalPago = 0;
        inputsPago.forEach(input => {
          if (input && input.value) {
            totalPago += parseFloat(input.value);
          }
        });
        const subTotal = parseFloat(localStorage.getItem('subTotal'));
        localStorage.setItem('totalPagoText',parseFloat(totalPago).toFixed(2));
        const vuelto = totalPago - subTotal;
        localStorage.setItem('vueltoText',parseFloat(vuelto).toFixed(2));
        
        acuenta= document.getElementById("acuentaselect").value;
        if (acuenta == "True" && totalPago < subTotal && vuelto <0) {
          localStorage.setItem('pagoConforme',true)
        } else if (totalPago < subTotal || (totalPago > subTotal && vuelto <= 0)) {
          console.error('El total de los pagos no coincide con el subtotal');
          localStorage.setItem('pagoConforme',false)
        } else {
          console.log('El total de los pagos coincide con el subtotal');
          localStorage.setItem('pagoConforme',true)       
        }

        cancelaDinero.textContent = "Cancela con: S/ " + localStorage.getItem("totalPagoText");
        vueltoDinero.textContent = "Vuelto: S/ " + localStorage.getItem("vueltoText");

      });
      
    })
    
    // Se colecta el formulario y se obtiene los datos del comprador
    const formulario_DatosComprador = document.getElementById("datosComprador");

    document.getElementById("botonDatosComprador").addEventListener("click",function(event){
      event.preventDefault();
      const formData = new FormData(formulario_DatosComprador);
      let data = {};
      formData.forEach((value,key)=>{
        data[key] = value;
      });

      // Obtener los productos de Local Storage
      let productos = JSON.parse(localStorage.getItem("productos"));

      // Agregando los productos al objeto data
      data["productos"] = productos;
      data["total_venta"] = localStorage.getItem("subTotal");
      data["total_pagado"] = localStorage.getItem("totalPagoText");
      data["vuelto"]= localStorage.getItem("vueltoText");

      // Pago Conforme
      pago_conforme=localStorage.getItem("pagoConforme");

      console.log(data);
      if (pago_conforme == "true") {
        $.ajax({
          url:"/crearnotaventa",
          type:"POST",
          data:JSON.stringify(data),
          contentType:"application/json;",
          dataType:"json",
          headers:{"X-CSRFToken": "{{ csrf_token() }}"},
          success:function(response){
            console.log(response);
            localStorage.removeItem("productos");
            localStorage.setItem("subTotal",0.00);
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;
            var JSONproductos = localStorage.getItem('productos');
            var products = JSONproductos ? JSON.parse(JSONproductos) : [];

            productos.forEach((element) => {
              let id = element.id;
              let tr = document.getElementById(id);
              tr.parentNode.removeChild(tr);
            });

            // Vaciar el array
            products.length = 0;

            // Guardar el array vacío de nuevo en localStorage
            localStorage.setItem('productos', JSON.stringify(products));
            localStorage.setItem('subTotal',0.00);
            document.getElementById("hTotal").textContent = "Total: S/0.00";
            document.getElementById("totalProductos").textContent = "0.00";

            cancelaDinero.textContent = "Cancela con: S/ " + "0.00";
            vueltoDinero.textContent = "Vuelto: S/ " + "0.00";
          },
          error:function(error){
            console.error(error);
            document.getElementById("messagesLoader").innerHTML=`
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                No se pudo guardar la Nota de Pedido
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;	
          }
        });
      } else {
        console.error("El total de los pagos no coincide con el subtotal");
        document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            El total de los pagos no coincide con el subtotal
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
      }
    });

    // Capturar el clic en el botón "Vaciar Productos"
    document.getElementById('cancelarNotaPedido').addEventListener('click', (event) => {
      // Eliminar la lista de productos de localStorage
      var JSONproductos = localStorage.getItem('productos');
      var products = JSONproductos ? JSON.parse(JSONproductos) : [];

      productos.forEach((element) => {
        let id = element.id;
        let tr = document.getElementById(id);
        tr.parentNode.removeChild(tr);
      });

      // Vaciar el array
      products.length = 0;

      // Guardar el array vacío de nuevo en localStorage
      localStorage.setItem('productos', JSON.stringify(products));
      localStorage.setItem('subTotal',0.00);
      document.getElementById("hTotal").textContent = "Total: S/0.00";
      document.getElementById("totalProductos").textContent = "0.00";
    });
  </script> 

  <script>
    //Si ya existen datos cargarlos cuando el DoomLoader terminte

    document.addEventListener('DOMContentLoaded',function(){
      if (localStorage.getItem("nombre_comprador") != null) {
        document.getElementById("nombre_comprador").value = localStorage.getItem("nombre_comprador");
        document.getElementById("direccion_comprador").value = localStorage.getItem("direccion_comprador");
        document.getElementById("telefono_comprador").value = localStorage.getItem("telefono_comprador");
        document.getElementById("dni_comprador").value = localStorage.getItem("dni_comprador");
      } else{
        document.getElementById("nombre_comprador").value = '';
        document.getElementById("direccion_comprador").value = '';
        document.getElementById("telefono_comprador").value = '';
        document.getElementById("dni_comprador").value = '';
      }
    
    })

    // Obtener datos de Compradores por DNI o RUC
    const buscarUsuarioDNI = document.getElementById("buscarUsuarioDNI");
    const botonBuscarUsuarioDNI = document.getElementById("botonBuscarUsuarioDNI");
    botonBuscarUsuarioDNI.addEventListener('click',(event)=>{
      event.preventDefault();
      const formData = new FormData(buscarUsuarioDNI);
      let data = {};
      formData.forEach((value,key)=>{
        data[key] = value;
      });

      $.ajax({
        url: "{{ url_for('buyer.buscarcompradorbydni') }}",
        type: "POST",
        data: JSON.stringify(data),
        contentType: "application/json;",
        dataType: "json",
        headers: {"X-CSRFToken": "{{ csrf_token() }}"},
        success:function(response){
          console.log(response);
          if (response[1]==200){
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;
            localStorage.setItem("nombre_comprador", response[0].nombre_comprador);
            localStorage.setItem("direccion_comprador", response[0].direccion_comprador);
            localStorage.setItem("telefono_comprador", response[0].telefono_comprador);
            localStorage.setItem("dni_comprador", response[0].dni_comprador);

            document.getElementById("nombre_comprador").value = localStorage.getItem("nombre_comprador");
            document.getElementById("direccion_comprador").value = localStorage.getItem("direccion_comprador");
            document.getElementById("telefono_comprador").value = localStorage.getItem("telefono_comprador");
            document.getElementById("dni_comprador").value = localStorage.getItem("dni_comprador");
          } else{
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;

            document.getElementById("nombre_comprador").value = '';
            document.getElementById("direccion_comprador").value = '';
            document.getElementById("telefono_comprador").value = '';
            document.getElementById("dni_comprador").value = '';

            localStorage.removeItem("nombre_comprador", response[0].nombre_comprador);
            localStorage.removeItem("direccion_comprador", response[0].direccion_comprador);
            localStorage.removeItem("telefono_comprador", response[0].telefono_comprador);
            localStorage.removeItem("dni_comprador", response[0].dni_comprador);

          }
          
            
        },error:function(error){
          console.error(error);
          document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-info alert-dismissible fade show" role="alert">
            El comprador no existe por favor registrelo
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
        }
      })
    })

  </script>

  <!--Script recuperar lista de productos-->
  <script>
    
    var productos= JSON.parse(localStorage.getItem("productos"));

    // Creamos la tabla
    let tabla=document.createElement("table");
    tabla.setAttribute("class","table table-striped table-hover");

    // Creamos el encabezado
    let thead=document.createElement("thead");
    let tr=document.createElement("tr");

    //Creando columnas
    let th1=document.createElement("th");
    th1.setAttribute("scope","col");
    th1.textContent="#";

    let th2=document.createElement("th");
    th2.setAttribute("scope","col");
    th2.textContent="Cantidad";

    let th3=document.createElement("th");
    th3.setAttribute("scope","col");
    th3.textContent="Producto";

    let th4=document.createElement("th");
    th4.setAttribute("scope","col");
    th4.textContent="Precio";

    let th5=document.createElement("th");
    th5.setAttribute("scope","col");
    th5.textContent="Subtotal";

    let th6=document.createElement("th");
    th6.setAttribute("scope","col");
    th6.textContent="Acciones";

    tr.appendChild(th1);
    tr.appendChild(th2);
    tr.appendChild(th3);
    tr.appendChild(th4);
    tr.appendChild(th5);
    tr.appendChild(th6);

    thead.appendChild(tr);

    tabla.appendChild(thead);

    
    // Llenar la tabla con los datos de productos
    let tbody=document.createElement("tbody");

    // Crea una variable total fuera del bucle para almacenar la suma de los subtotales.
    let total = 0;

    productos.forEach((element,index) => {
      let tr = document.createElement("tr");
      tr.setAttribute("id",element.id);

      let th= document.createElement("th");
      th.setAttribute("scope","row");
      th.textContent = index+1;

      let td1 = document.createElement("td");
      let inputCantidad=document.createElement("input");
      inputCantidad.setAttribute("class","tabla-input");
      inputCantidad.setAttribute("type","number");
      inputCantidad.setAttribute("min","0.1");
      inputCantidad.setAttribute("step","0.1");
      inputCantidad.setAttribute("value",element.cantidad);
      td1.appendChild(inputCantidad);

      inputCantidad.addEventListener("input",function(){
        let id = this.parentNode.parentNode.getAttribute("id");
        let cantidad = this.value;
        let precio = document.getElementById(id).childNodes[3].childNodes[0].value;
        let subtotal = cantidad*precio;
        document.getElementById(id).childNodes[4].textContent = subtotal.toFixed(2);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.map(function(producto){
          if(producto.id == id){
            producto.cantidad = cantidad;
          }
          return producto;
        });
        localStorage.setItem("productos",JSON.stringify(productosActualizados));
        // Actualiza la variable total
        updateTotal();
      });

      let td2 = document.createElement("td");
      td2.textContent = element.nombre_producto;

      let td3 = document.createElement("td");
      let inputPrecio=document.createElement("input");
      inputPrecio.setAttribute("class","tabla-input");
      inputPrecio.setAttribute("type","number");
      inputPrecio.setAttribute("min","0.1");
      inputPrecio.setAttribute("step","0.1");
      inputPrecio.setAttribute("value",element.precio_venta_producto);
      td3.appendChild(inputPrecio);

      inputPrecio.addEventListener("input",function(){
        let id = this.parentNode.parentNode.getAttribute("id");
        let precio = this.value;
        let cantidad = document.getElementById(id).childNodes[1].childNodes[0].value;
        let subtotal = cantidad*precio;
        document.getElementById(id).childNodes[4].textContent = subtotal.toFixed(2);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.map(function(producto){
          if(producto.id == id){
            producto.precio_venta_producto = precio;
          }
          return producto;
        });

        localStorage.setItem("productos",JSON.stringify(productosActualizados));

        // Actualiza la variable total
        updateTotal();
      });

      let td4 = document.createElement("td");
      td4.textContent =  (element.precio_venta_producto*element.cantidad).toFixed(2);

      let td5 = document.createElement("td");
      let button = document.createElement("button");
      button.setAttribute("class","btn btn-danger");
      button.setAttribute("id",element.id);
      button.textContent = "Eliminar";
      button.addEventListener("click",function(){
        let id = this.getAttribute("id");
        let tr = document.getElementById(id);
        tr.parentNode.removeChild(tr);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.filter(function(producto){
          return producto.id != id;
        });

        localStorage.setItem("productos",JSON.stringify(productosActualizados));

        // Actualiza la variable total
        updateTotal();
      });

      td5.appendChild(button);

      tr.appendChild(th);
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);
      tr.appendChild(td5);
      tbody.appendChild(tr);
      
    });

    function updateTotal() {
      // Recalcula el total sumando todos los subtotales
      total = 0;
      // Obtienes la lista de productos actualizada
      let productos = JSON.parse(localStorage.getItem("productos"));
      productos.forEach((element) => {
          let id = element.id;
          let subtotal = parseFloat(document.getElementById(id).childNodes[4].textContent);
          total += subtotal;
      });
      document.getElementById("totalProductos").textContent = total.toFixed(2);
      document.getElementById("hTotal").textContent = "Total: S/"+total.toFixed(2);
      localStorage.setItem("subTotal",total.toFixed(2));
      
    }

    tabla.appendChild(tbody);

    let tableFooter = document.createElement("tfoot");
    let trFooter = document.createElement("tr");
    let tdFooter = document.createElement("td");
    tdFooter.setAttribute("colspan","4");
    tdFooter.setAttribute("style","text-align: right; font-weight: bold;");
    tdFooter.textContent = "Total: ";


    let tdFooterTotal = document.createElement("td");
    tdFooterTotal.setAttribute("id","totalProductos");
    tdFooterTotal.textContent = localStorage.getItem("subTotal");
    document.getElementById("hTotal").textContent = "Total: S/"+localStorage.getItem("subTotal");
    
    trFooter.appendChild(tdFooter);
    trFooter.appendChild(tdFooterTotal);
    tableFooter.appendChild(trFooter);


    tabla.appendChild(tableFooter);

    tabla_productos = document.getElementById("tabla-productos");
    tabla_productos.appendChild(tabla);

  </script>
{% endblock %}