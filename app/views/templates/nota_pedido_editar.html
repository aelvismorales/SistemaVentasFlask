{%extends 'base.html' %}

{% block csslink %}
    <link rel="stylesheet" href="{{url_for('static',filename='css/nota_pedido.css')}}" />
{%endblock%}

{% block navbar %}
 <li class="nav-item">
    <a class="nav-link" aria-current="page" href="{{ url_for('product.buscar_producto')}}"><strong>Productos</strong></a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{{url_for('note.ver_notas_pedido')}}" aria-current="page"><strong>Ve Notas de Pedido</strong></a>
  </li>

  <li class="nav-item">
    <a class="nav-link" href="#" aria-current="page"><strong>Ver Compradores</strong></a>
  </li>
  
  <li class="nav-item">
    <a class="nav-link" href="{{url_for('auth.logout')}}"><strong>Cerrar Sesion</strong></a>
  </li>
{% endblock %}

{% block messages %} 
  <div id="messagesLoader">

  </div>
{%endblock%}

{% block content %} 
  <div class="container-general">
    <div class="header-nota">
        <h2>Edicion de Nota de Pedido</h2>
        <p>{{ current_user.get_nickname()}}</p>
    </div>
    <div class="container-comprador">
      <form action="#" method="post" id="buscarUsuarioDNI">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="input-group mb-3">
          <input type="text" class="form-control" placeholder="Buscar por DNI" aria-label="Buscar por DNI" aria-describedby="button-addon2" name="dni_comprador">
          <button class="btn btn-outline-success" type="submit" id="botonBuscarUsuarioDNI">Buscar</button>
        </div>
      </form>

      <form action="#" id="datosComprador" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="datos-usuario">
          <h4 style="text-align: left;">Datos Comprador</h3> 
          <div class="datos">

            <!--Nombre Comprador-->
            <div class="mb-3 row">
              <label for="nombre_comprador" class="col-sm-2 col-form-label">Comprador:</label>
              <div class="col-sm-10">
                <input type="text" class="form-control"  name="nombre_comprador" id="nombre_comprador" value="{{nota.nombre_comprador}}"required>
              </div>
            </div>

            <!--Direccion Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="direccion_comprador">Direccion:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="direccion_comprador" id="direccion_comprador" value="{{nota.direccion_comprador}}" required>
              </div>
            </div>
            
            <!--DNI Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="dni_comprador">DNI:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="dni_comprador" id="dni_comprador" value="{{nota.dni_comprador}}" required>
              </div>
            </div>

            <!--Telefono Comprador-->
            <div class="mb-3 row">
              <label class="col-sm-2 col-form-label" for="telefono_comprador" >Telefono:</label>
              <div class="col-sm-10">
                <input class="form-control" type="text" name="telefono_comprador" id="telefono_comprador" value="{{nota.numero_comprador}}" required>
              </div>
            </div>
            
            <!--Estado 1-->
            {% set estados= nota.estado.split("-")%}
            <div class="input-group mb-1">
              <label class="input-group-text" for="inputEstado1">Estado:</label>
              <select class="form-select" name="inputEstado1" id="inputEstado1" required>
                <option {{ 'selected' if 'Seleccione' in estados else '' }}>Seleccione</option>
                <option value="CANCELADO" {{ 'selected' if 'CANCELADO' in estados else '' }}>CANCELADO</option>
                <option value="POR-CANCELAR" {{ 'selected' if 'POR' and 'CANCELAR' in estados else '' }}>POR CANCELAR</option>
                <option value="PROFORMA" {{ 'selected' if 'PROFORMA' in estados else '' }}>PROFORMA</option>
              </select>

              <!--Estado 2-->
              <select class="form-select" name="inputEstado2" id="inputEstado2" aria-label="Estado2" required>
                <option {{ 'selected' if 'Seleccione' in estados else '' }}>Seleccione</option>
                <option value="-" {{ 'selected' if '-' in estados else '' }}>-</option>
                <option value="ENTREGADO" {{ 'selected' if 'ENTREGADO' in estados else '' }}>ENTREGADO</option>
                <option value="POR-ENTREGAR" {{ 'selected' if 'POR' and 'ENTREGAR' in estados else '' }}>POR ENTREGAR</option>
              </select>
            </div>

            <div class="info-cancela">
              <h5 id="cancela-dinero"></h5>
              <h5 id="vuelto-dinero"></h5>
            </div>
          </div>        
        </div>

        <div class="datos-generales">
          <div class="metodos-pago">
            <h4 style="text-align: center;">Metodos de Pago</h3>
            <div class="input-group mb-2">
              <label class="input-group-text" for="acuenta">Acuenta</label>
              <select class="form-select" name="acuenta" id="acuentaselect">
                <option value="False" >No</option>
                <option value="True" {{ 'selected' if nota.bool_acuenta else ''}}>Si</option>
              </select>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" id="pagoEfectivo" aria-label="pagoEfectivo" >
              <div class="input-group">
                <span class="input-group-text" id="pagoEfectivoSpan">Efectivo</span>
                <input class="form-control" type="number" name="pagoEfectivoInput" id="pagoEfectivoInput" placeholder="0.00" min="0.1" step="0.01"  value="{{ nota.pagoEfectivo if nota.pagoEfectivo else 0.00}}" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" id="pagoVisa" aria-label="pagoVisa" >
              <div class="input-group">
                <span class="input-group-text" id="pagoVisaSpan">Visa</span>
                <input class="form-control" type="number" name="pagoVisaInput" id="pagoVisaInput" placeholder="0.00" min="0.1" step="0.01" value="{{ nota.pagoVisa if nota.pagoVisa else 0.00}}" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" id="pagoBBVA" aria-label="pagoBBVA" >
              <div class="input-group">
                <span class="input-group-text" id="pagoBBVASpan">BBVA</span>
                <input class="form-control" type="number" name="pagoBBVAInput" id="pagoBBVAInput" placeholder="0.00" min="0.1" step="0.01" value="{{nota.pagoBBVA if nota.pagoBBVA else 0.00}}" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" id="pagoBCP" aria-label="pagoBCP" >
              <div class="input-group">
                <span class="input-group-text" id="pagoBCPSpan">BCP</span>
                <input class="form-control" type="number" name="pagoBCPInput" id="pagoBCPInput" placeholder="0.00" min="0.1" step="0.01" value="{{nota.pagoBCP if nota.pagoBCP else 0.00}}" disabled>
              </div>
            </div>

            <div class="form-check pagos mb-2">
              <input class="form-check-input" type="checkbox" value="" id="pagoYAPE" aria-label="pagoYAPE" >
              <div class="input-group">
                <span class="input-group-text" id="pagoYapeSpan">Yape</span>
                <input class="form-control" type="number" name="pagoYAPEInput" id="pagoYAPEInput" placeholder="0.00" min="0.1" step="0.01" value="{{nota.pagoYape if nota.pagoYape else 0.00}}" disabled>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div id="tabla-productos" class="container-tabla-productos">

    </div>

    <div class="container-botones-final">
      <div class="total">
        <h4 id="hTotal"></h4>
      </div>
      <div class="botones">
        <button class="btn btn-danger" id="vaciarNotaPedido">Vaciar Productos</button>
        <button class="btn btn-warning" id="cancelarEdicionNotaPedido">Cancelar Edicion </button>
        <button class="btn btn-success" id="botonDatosComprador" type="submit">Guardar</button>
        
      </div>
  </div>

  {%endblock%}

  {% block scripts %}
  <!--Cosas que verificar cuando todo el contenido se carga Doom Loaded-->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Items que se cargan una sola vez si no se ha ejecutado el codigo
      if (!localStorage.getItem("isCodeExecuted")) {
        var jsonProductosSession="{{session['productos']}}";
        var correctedJsonString = jsonProductosSession.replace(/&#34;/g, '\"');
        
        //total_venta_session -> Es el total de todos los productos de la nota de Pedido
        //localStorage.setItem("total_venta_session","{{session['total_venta']}}");
        localStorage.setItem('subTotal',"{{session['total_venta']}}");
        localStorage.setItem("productos",correctedJsonString);
        localStorage.setItem("isCodeExecuted", true);
      }

      // Actualiza el total de pago y vuelto
      updateTotalPagoText();
      updatePagoConforme();



    });
  </script>


  <!--Logica del Manejo de Inputs de Pago,Vuelto y Validacion de Formulario-->
  <script>
    
    //Variable LocalStorage modoEdicion
    localStorage.setItem("modoEdicion",true);

    // Coleccion de los checboxes y los inputs, se cambia el estado de habilitado segun el cambio de checkbox.
    const inputsPagoSelected = [
      { checkbox: document.getElementById("pagoEfectivo"), input: document.getElementById("pagoEfectivoInput") },
      { checkbox: document.getElementById("pagoVisa"), input: document.getElementById("pagoVisaInput") },
      { checkbox: document.getElementById("pagoBBVA"), input: document.getElementById("pagoBBVAInput") },
      { checkbox: document.getElementById("pagoBCP"), input: document.getElementById("pagoBCPInput") },
      { checkbox: document.getElementById("pagoYAPE"), input: document.getElementById("pagoYAPEInput") }
    ];

    inputsPagoSelected.forEach(({checkbox, input}) => {
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          input.removeAttribute('disabled');
        } else {
          input.setAttribute('disabled', true);
          input.value = 0.00;
        }
      });
    });

    // Funcion para actualizar las condiciones de pago son conformes
    function updatePagoConforme(){
      const acuenta = document.getElementById("acuentaselect").value;
      const totalPago = parseFloat(localStorage.getItem('totalPagoText'));
      const subTotal = parseFloat(localStorage.getItem('subTotal'));
      const vuelto = parseFloat(localStorage.getItem('vueltoText'));

      if (acuenta == "True"){
          if (totalPago < subTotal && vuelto < 0) {
            localStorage.setItem('pagoConforme',true)
          } else {
            localStorage.setItem('pagoConforme',false)
          }
      }else{
        if (totalPago >= subTotal && vuelto >= 0) {
          localStorage.setItem('pagoConforme',true)
        } else {
          localStorage.setItem('pagoConforme',false)
        }
      }

    }
    
    // Se colecta los inputs de los pagos y se calcula el vuelto
    const cancelaDinero = document.getElementById("cancela-dinero");
    const vueltoDinero = document.getElementById("vuelto-dinero");

    // Funcion para actualizar el total de pago y vuelto
    // Me sirve para sumar los valores que tenga check y actualizar los campos de Cancela con y Vuelto
    function updateTotalPagoText(){
      let totalPago = 0;
      inputsPagoSelected.forEach(({checkbox,input})=>{
        if (checkbox.checked && input.value) {
          totalPago += parseFloat(input.value);
        } else if(input.value){
          //input.value = 0.00;
          //totalPago -= parseFloat(input.value);
          //if (totalPago < 0) {
          //  totalPago = 0.00;
          //}
          totalPago += parseFloat(input.value);
        }
      })
      //total_pago -> Es la cantidad que la persona cancela
      //subTotal -> Es el total de la venta
      
      localStorage.setItem('totalPagoText',parseFloat(totalPago).toFixed(2));
      // Quizas una funcion que me permita obtener el valor actual del subTotal sumando los datos de la Tabla de Productos.
      const subTotal = parseFloat(localStorage.getItem('subTotal'));
      const vuelto = totalPago - subTotal;
      localStorage.setItem('vueltoText',parseFloat(vuelto).toFixed(2));
      //updatePagoConforme();
      cancelaDinero.textContent = "Cancela con: S/ " + localStorage.getItem("totalPagoText");
      vueltoDinero.textContent = "Vuelto: S/ " + localStorage.getItem("vueltoText");
    }

    inputsPagoSelected.forEach(({checkbox,input})=>{
      input.addEventListener('input',updateTotalPagoText);
      checkbox.addEventListener('change',updateTotalPagoText);
    })

    const acuentaselect = document.getElementById("acuentaselect");
    acuentaselect.addEventListener('change',updateTotalPagoText);

    document.getElementById("botonDatosComprador").addEventListener('click',function(event){
      /* Al momento de dar click verificar los totales pagados y si el pago es conforme*/
      updateTotalPagoText();
      updatePagoConforme();
      
      // Obteniendo datos del comprador del Formulario
      const formulario_DatosComprador = document.getElementById("datosComprador");
      const formData = new FormData(formulario_DatosComprador);
      let data = {};

      // Verificar si el formulario tiene datos validos para enviar 
      if (formulario_DatosComprador.checkValidity()){
        formData.forEach((value,key)=>{
          data[key] = value;
        });
        
        // Validar que el nombre_comprador solo tenga letras,espacio o ['*','-','.']
        if (data["nombre_comprador"].match(/^[a-zA-Z\s*-.]+$/) == null){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              El nombre del comprador solo puede tener letras,espacio o ['*','-','.']
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;  
          return;
        }

        // Validar que el campo DNI solo contenga numero o ['*','-','.']
        if (data["dni_comprador"].match(/^[0-9*-.]+$/) == null){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              El DNI del comprador solo puede tener numeros o ['*','-','.']
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;
          return;     
        }

        // Validar que el campo telefono_comprador solo contenga numeros o ['*','-','.']
        if (data["telefono_comprador"].match(/^[0-9*-.]+$/) == null){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              El telefono del comprador solo puede tener numeros o ['*','-','.']
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;       
          return;   
        }

        // Validar que los campos Comprador,DNI, Telefono y Dirección no esten vacios
        if (data["nombre_comprador"] == "" || data["dni_comprador"] == "" || data["telefono_comprador"] == "" || data["direccion_comprador"] == ""){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              Los campos Comprador,DNI, Telefono y Dirección no pueden estar vacios
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;   
          return;
        }

        if (data["inputEstado1"] == "Seleccione" || data["inputEstado2"] == "Seleccione"){
          document.getElementById("messagesLoader").innerHTML = `
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              Los campos Estado no pueden estar vacios, seleccione un estado
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
                aria-label="Close"
              ></button>
            </div>
          `;   
          return;
        }	

      // Obtener los productos de Local Storage
      let productos = JSON.parse(localStorage.getItem("productos"));

      // Agregando los productos al objeto data
      data["productos"] = productos;
      data["total_venta"] = localStorage.getItem("subTotal"); // Este valor debe ser la suma de todos los productos.
      data["total_pagado"] = localStorage.getItem("totalPagoText");
      data["vuelto"]= localStorage.getItem("vueltoText");
      data["pagoEfectivo"] = document.getElementById("pagoEfectivoInput").value;
      data["pagoVisa"] = document.getElementById("pagoVisaInput").value;
      data["pagoBBVA"] = document.getElementById("pagoBBVAInput").value;
      data["pagoBCP"] = document.getElementById("pagoBCPInput").value;
      data["pagoYape"] = document.getElementById("pagoYAPEInput").value;

      // Validar que los Input Pago no tengan valores negativos
      if (data["pagoEfectivo"] < 0 || data["pagoVisa"] < 0 || data["pagoBBVA"] < 0 || data["pagoBCP"] < 0 || data["pagoYape"] < 0){
        document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            Los campos de pago no pueden tener valores negativos
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;   
        return;
      }

      // Pago Conforme
      pago_conforme=localStorage.getItem("pagoConforme");

      if (pago_conforme == "true"){
        $.ajax({
          url: "/editarnotaventa/"+"{{session['id_nota']}}",
          type: "POST",
          data: JSON.stringify(data),
          contentType: "application/json;",
          dataType: "json",
          headers: {"X-CSRFToken": "{{ csrf_token() }}"},
          success:function(response){
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;
            //localStorage.removeItem("productos");
            
            var JSONproductos = localStorage.getItem('productos');
            var products = JSONproductos ? JSON.parse(JSONproductos) : [];

            productos.forEach((element) => {
              let id = element.id;
              let tr = document.getElementById(id);
              tr.parentNode.removeChild(tr);
            });

            // Vaciar el array
            products.length = 0;
            localStorage.setItem('productos', JSON.stringify(products));
            
            //localStorage.setItem("total_venta_session",0.00);
            localStorage.setItem('subTotal',0.00);
            localStorage.removeItem("modoEdicion");
            localStorage.removeItem("isCodeExecuted");
            
            document.getElementById("hTotal").textContent = "Total: S/0.00";
            // El ID total_productos es de la tabla de productos
            document.getElementById("totalProductos").textContent = "0.00";
          },
          error:function(error){
            console.error(error);
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                No se pudo guardar la Nota de Pedido
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;	
          }
        })
      } else {
        document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            El total de los pagos no coincide con el subtotal
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
      }
    }
    event.preventDefault();
    });

    // Capturar el clic en el botón "Vaciar Productos"
    document.getElementById('vaciarNotaPedido').addEventListener('click', (event) => {
      // Vaciar la lista de productos de localStorage
      var JSONproductos = localStorage.getItem('productos');
      var products = JSONproductos ? JSON.parse(JSONproductos) : [];

      products.forEach((element) => {
        let id = element.id;
        let tr = document.getElementById(id);
        tr.parentNode.removeChild(tr);
      });

      // Vaciar el array
      products.length = 0;

      // Guardar el array vacío de nuevo en localStorage
      localStorage.setItem('productos', JSON.stringify(products));
      //localStorage.setItem('total_venta_session',0.00);
      
      localStorage.setItem('totalPagoText',0.00);
      localStorage.setItem('vueltoText',0.00);
      localStorage.setItem('pagoConforme',false);
      localStorage.setItem('isCodeExecuted',false);
      localStorage.setItem('modoEdicion',false);
      localStorage.setItem('subTotal',0.00);
      
      document.getElementById("hTotal").textContent = "Total: S/0.00";
      document.getElementById("totalProductos").textContent = "0.00";
      window.location.href = "{{url_for('note.ver_notas_pedido')}}";
      event.preventDefault();
    });
  </script> 

  <script>
    // Obtener datos de Compradores por DNI o RUC
    const buscarUsuarioDNI = document.getElementById("buscarUsuarioDNI");
    const botonBuscarUsuarioDNI = document.getElementById("botonBuscarUsuarioDNI");
    botonBuscarUsuarioDNI.addEventListener('click',(event)=>{
      event.preventDefault();
      const formData = new FormData(buscarUsuarioDNI);
      let data = {};
      formData.forEach((value,key)=>{
        data[key] = value;
      });

      $.ajax({
        url: "{{ url_for('buyer.buscarcompradorbydni') }}",
        type: "POST",
        data: JSON.stringify(data),
        contentType: "application/json;",
        dataType: "json",
        headers: {"X-CSRFToken": "{{ csrf_token() }}"},
        success:function(response){
          console.log(response);
          if (response[1]==200){
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;
            localStorage.setItem("nombre_comprador", response[0].nombre_comprador);
            localStorage.setItem("direccion_comprador", response[0].direccion_comprador);
            localStorage.setItem("telefono_comprador", response[0].telefono_comprador);
            localStorage.setItem("dni_comprador", response[0].dni_comprador);

            document.getElementById("nombre_comprador").value = localStorage.getItem("nombre_comprador");
            document.getElementById("direccion_comprador").value = localStorage.getItem("direccion_comprador");
            document.getElementById("telefono_comprador").value = localStorage.getItem("telefono_comprador");
            document.getElementById("dni_comprador").value = localStorage.getItem("dni_comprador");
          } else{
            document.getElementById("messagesLoader").innerHTML = `
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                ${response[0].message}
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="alert"
                  aria-label="Close"
                ></button>
              </div>
            `;

            document.getElementById("nombre_comprador").value = '';
            document.getElementById("direccion_comprador").value = '';
            document.getElementById("telefono_comprador").value = '';
            document.getElementById("dni_comprador").value = '';

            localStorage.removeItem("nombre_comprador", response[0].nombre_comprador);
            localStorage.removeItem("direccion_comprador", response[0].direccion_comprador);
            localStorage.removeItem("telefono_comprador", response[0].telefono_comprador);
            localStorage.removeItem("dni_comprador", response[0].dni_comprador);

          }
          
            
        },error:function(error){
          console.error(error);
          document.getElementById("messagesLoader").innerHTML = `
          <div class="alert alert-info alert-dismissible fade show" role="alert">
            El comprador no existe por favor registrelo
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
        `;
        }
      })
    })

  </script>

  <!--Script recuperar lista de productos-->
  <script>
    var JSONproductos = localStorage.getItem("productos");
    var productos= JSONproductos ? JSON.parse(JSONproductos) : [];

    // Creamos la tabla
    let tabla=document.createElement("table");
    tabla.setAttribute("class","table table-striped table-hover responsive");

    // Creamos el encabezado
    let thead=document.createElement("thead");
    let tr=document.createElement("tr");

    //Creando columnas
    let th1=document.createElement("th");
    th1.setAttribute("scope","col");
    th1.textContent="#";

    let th2=document.createElement("th");
    th2.setAttribute("scope","col");
    th2.textContent="Cantidad";

    let th3=document.createElement("th");
    th3.setAttribute("scope","col");
    th3.textContent="Producto";

    let th4=document.createElement("th");
    th4.setAttribute("scope","col");
    th4.textContent="Precio";

    let th5=document.createElement("th");
    th5.setAttribute("scope","col");
    th5.textContent="Subtotal";

    let th6=document.createElement("th");
    th6.setAttribute("scope","col");
    th6.textContent="Acciones";

    tr.appendChild(th1);
    tr.appendChild(th2);
    tr.appendChild(th3);
    tr.appendChild(th4);
    tr.appendChild(th5);
    tr.appendChild(th6);

    thead.appendChild(tr);

    tabla.appendChild(thead);

    
    // Llenar la tabla con los datos de productos
    let tbody=document.createElement("tbody");

    // Crea una variable total fuera del bucle para almacenar la suma de los subtotales.
    let total = 0;

    productos.forEach((element,index) => {
      let tr = document.createElement("tr");
      tr.setAttribute("id",element.id);

      let th= document.createElement("th");
      th.setAttribute("scope","row");
      th.textContent = index+1;

      let td1 = document.createElement("td");
      let inputCantidad=document.createElement("input");
      inputCantidad.setAttribute("class","tabla-input");
      inputCantidad.setAttribute("type","number");
      inputCantidad.setAttribute("min","0.1");
      inputCantidad.setAttribute("step","0.1");
      inputCantidad.setAttribute("value",element.cantidad);
      td1.appendChild(inputCantidad);

      inputCantidad.addEventListener("input",function(){
        let id = this.parentNode.parentNode.getAttribute("id");
        let cantidad = this.value;
        let precio = document.getElementById(id).childNodes[3].childNodes[0].value;
        let subtotal = cantidad*precio;
        document.getElementById(id).childNodes[4].textContent = subtotal.toFixed(2);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.map(function(producto){
          if(producto.id == id){
            producto.cantidad = cantidad;
          }
          return producto;
        });
        localStorage.setItem("productos",JSON.stringify(productosActualizados));
        // Actualiza la variable total
        updateTotal();
      });

      let td2 = document.createElement("td");
      td2.textContent = element.nombre_producto;

      let td3 = document.createElement("td");
      let inputPrecio=document.createElement("input");
      inputPrecio.setAttribute("class","tabla-input");
      inputPrecio.setAttribute("type","number");
      inputPrecio.setAttribute("min","0.1");
      inputPrecio.setAttribute("step","0.1");
      inputPrecio.setAttribute("value",element.precio_venta_producto);
      td3.appendChild(inputPrecio);

      inputPrecio.addEventListener("input",function(){
        let id = this.parentNode.parentNode.getAttribute("id");
        let precio = this.value;
        let cantidad = document.getElementById(id).childNodes[1].childNodes[0].value;
        let subtotal = cantidad*precio;
        document.getElementById(id).childNodes[4].textContent = subtotal.toFixed(2);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.map(function(producto){
          if(producto.id == id){
            producto.precio_venta_producto = precio;
          }
          return producto;
        });

        localStorage.setItem("productos",JSON.stringify(productosActualizados));

        // Actualiza la variable total
        updateTotal();
      });

      let td4 = document.createElement("td");
      td4.textContent =  (element.precio_venta_producto*element.cantidad).toFixed(2);

      let td5 = document.createElement("td");
      let button = document.createElement("button");
      button.setAttribute("class","btn btn-danger");
      button.setAttribute("id",element.id);
      button.textContent = "Eliminar";
      button.addEventListener("click",function(){
        let id = this.getAttribute("id");
        let tr = document.getElementById(id);
        tr.parentNode.removeChild(tr);

        var JSONproductos = JSON.parse(localStorage.getItem("productos"));
        var productosActualizados = JSONproductos.filter(function(producto){
          return producto.id != id;
        });

        localStorage.setItem("productos",JSON.stringify(productosActualizados));

        // Actualiza la variable total
        updateTotal();
      });

      td5.appendChild(button);

      tr.appendChild(th);
      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);
      tr.appendChild(td5);
      tbody.appendChild(tr);
      
    });

    function updateTotal() {
      // Recalcula el total sumando todos los subtotales
      total = 0;
      // Obtienes la lista de productos actualizada
      let productos = JSON.parse(localStorage.getItem("productos"));
      productos.forEach((element) => {
          let id = element.id;
          let subtotal = parseFloat(document.getElementById(id).childNodes[4].textContent);
          total += subtotal;
      });
      document.getElementById("totalProductos").textContent = total.toFixed(2);
      document.getElementById("hTotal").textContent = "Total: S/"+total.toFixed(2);
      //localStorage.setItem("total_venta_session",total.toFixed(2));
      localStorage.setItem('subTotal',total.toFixed(2));     
    }
    
    tabla.appendChild(tbody);

    let tableFooter = document.createElement("tfoot");
    let trFooter = document.createElement("tr");
    let tdFooter = document.createElement("td");
    tdFooter.setAttribute("colspan","4");
    tdFooter.setAttribute("style","text-align: right; font-weight: bold;");
    tdFooter.textContent = "Total: ";


    let tdFooterTotal = document.createElement("td");
    tdFooterTotal.setAttribute("id","totalProductos");
    tdFooterTotal.textContent = localStorage.getItem("subTotal");
    document.getElementById("hTotal").textContent = "Total: S/"+localStorage.getItem("subTotal");
    
    trFooter.appendChild(tdFooter);
    trFooter.appendChild(tdFooterTotal);
    tableFooter.appendChild(trFooter);


    tabla.appendChild(tableFooter);

    tabla_productos = document.getElementById("tabla-productos");
    tabla_productos.appendChild(tabla);

  </script>

  <script>
    // Cancelar Edicion
    document.getElementById("cancelarEdicionNotaPedido").addEventListener("click",function(){
      var JSONproductos = localStorage.getItem('productos');
      var products = JSONproductos ? JSON.parse(JSONproductos) : [];

      products.forEach((element) => {
        let id = element.id;
        let tr = document.getElementById(id);
        tr.parentNode.removeChild(tr);
      });

      // Vaciar el array
      products.length = 0;

      // Guardar el array vacío de nuevo en localStorage
      localStorage.setItem('productos', JSON.stringify(products));

      //localStorage.removeItem("productos");
      //localStorage.setItem("total_venta_session",0.00);
      localStorage.setItem('subTotal',0.00);
      localStorage.setItem('totalPagoText',0.00);
      localStorage.setItem('vueltoText',0.00);
      localStorage.setItem('pagoConforme',false);
      localStorage.setItem('isCodeExecuted',false);
      localStorage.setItem('modoEdicion',false);
      localStorage.setItem('subTotal',0.00);
      window.location.href = "{{url_for('note.ver_notas_pedido')}}";
    });
  </script>
{% endblock %}